<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>techminer2.ingest.ingest_raw_data &mdash; TechMiner 2+ Jul 21, 2023 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script src="../../../_static/toggleprompt.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            TechMiner 2+
          </a>
              <div class="version">
                Jul 21, 2023
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">INTRODUCTION</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/release_info.html">Release Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/license.html">MIT License</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TECHMINER 2++</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/ingest/__index__.html">Ingest/</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/refine/__index__.html">Refine/</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/search/__index__.html">Search/</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/co_occurrence_analysis/__index__.html">Co-occurrence Analysis/</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/co_word_analysis/__index__.html">Co-word Analysis/</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/correlation_analysis/__index__.html">Correlation Analysis/</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/emergence_analysis/__index__.html">Emergence Analysis/</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/factor_analysis/__index__.html">Factor Analysis/</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/network_analysis/__index__.html">Network Analysis/</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/performance_analysis/__index__.html">Performance Analysis/</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/time_analysis/__index__.html">Time Analysis/</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../techminer/thematic_analysis/__index__.html">Thematic Analysis/</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">EXAMPLES / HOW'S TO</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../bibliometrix/__index__.html">Bibliometrix 4.1.3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../vantagepoint/__index__.html">VantagePoint v15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tlab/__index__.html">T-LAB 10.1.5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scientopy/__index__.html">ScientoPy 2.1.3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../vosviewer/__index__.html">VOSviewer 1.6.19</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TechMiner 2+</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">techminer2.ingest.ingest_raw_data</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for techminer2.ingest.ingest_raw_data</h1><div class="highlight"><pre>
<span></span><span class="c1"># flake8: noqa</span>
<span class="c1"># pylint: disable=invalid-name</span>
<span class="c1"># pylint: disable=line-too-long</span>
<span class="c1"># pylint: disable=missing-docstring</span>
<span class="c1"># pylint: disable=too-many-arguments</span>
<span class="c1"># pylint: disable=too-many-locals</span>
<span class="c1"># pylint: disable=too-many-statements</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. _ingest.ingest_raw_data:</span>

<span class="sd">Ingest Raw Data</span>
<span class="sd">===============================================================================</span>

<span class="sd">Import a scopus data file in the working directory.</span>

<span class="sd">&gt;&gt;&gt; from techminer2.ingest import ingest_raw_data</span>
<span class="sd">&gt;&gt;&gt; ingest_raw_data(</span>
<span class="sd">...     #</span>
<span class="sd">...     # DATABASE PARAMS:</span>
<span class="sd">...     root_dir=&quot;data/regtech/&quot;, </span>
<span class="sd">...     disable_progress_bar=True</span>
<span class="sd">... )</span>
<span class="sd">--INFO-- Concatenating raw files in data/regtech/raw-data/cited_by/</span>
<span class="sd">--INFO-- Concatenating raw files in data/regtech/raw-data/references/</span>
<span class="sd">--INFO-- Concatenating raw files in data/regtech/raw-data/main/</span>
<span class="sd">--INFO-- Applying scopus tags to database files</span>
<span class="sd">--INFO-- Formatting column names in database files</span>
<span class="sd">--INFO-- Repairing authors ID</span>
<span class="sd">--INFO-- Repairing bad separators in keywords</span>
<span class="sd">--INFO-- Dropping NA columns in database files</span>
<span class="sd">--INFO-- Removed columns: {&#39;page_count&#39;}</span>
<span class="sd">--INFO-- Processing text columns (remove accents)</span>
<span class="sd">--INFO-- Processing text columns (remove stranger chars)</span>
<span class="sd">--INFO-- Removing records with `raw_authors` in [&#39;Anon&#39;, &#39;[No author name available]&#39;]</span>
<span class="sd">--INFO-- Removed 1 records</span>
<span class="sd">--INFO-- Processing `authors_id` column</span>
<span class="sd">--INFO-- Processing `document_type` column</span>
<span class="sd">--INFO-- Processing `eissn` column</span>
<span class="sd">--INFO-- Processing `global_citations` column</span>
<span class="sd">--INFO-- Processing `isbn` column</span>
<span class="sd">--INFO-- Processing `issn` column</span>
<span class="sd">--INFO-- Processing `raw_authors` column</span>
<span class="sd">--INFO-- Processing `source_name` column</span>
<span class="sd">--INFO-- Mask `source_abbr` column with `source_name`</span>
<span class="sd">--INFO-- Processing `source_abbr` column</span>
<span class="sd">--INFO-- Processing `doi` column</span>
<span class="sd">--INFO-- Disambiguating `authors` column</span>
<span class="sd">--INFO-- Copying `authors` column to `num_authors`</span>
<span class="sd">--INFO-- Processing `num_authors` column</span>
<span class="sd">--INFO-- Copying `global_references` column to `num_global_references`</span>
<span class="sd">--INFO-- Processing `num_global_references` column</span>
<span class="sd">--INFO-- Creating `article` column</span>
<span class="sd">--INFO-- Processing `raw_author_keywords` column</span>
<span class="sd">--INFO-- Processing `raw_index_keywords` column</span>
<span class="sd">--INFO-- Concatenating `raw_author_keywords` and `raw_index_keywords` columns to `raw_keywords`</span>
<span class="sd">--INFO-- Processing `title` column</span>
<span class="sd">--INFO-- Copying `title` column to `raw_title_nlp_phrases`</span>
<span class="sd">--INFO-- Processing `raw_title_nlp_phrases` column</span>
<span class="sd">--INFO-- Processing `abstract` column</span>
<span class="sd">--INFO-- Copying `abstract` column to `raw_abstract_nlp_phrases`</span>
<span class="sd">--INFO-- Processing `raw_abstract_nlp_phrases` column</span>
<span class="sd">--INFO-- Concatenating `raw_title_nlp_phrases` and `raw_abstract_nlp_phrases` columns to `raw_nlp_phrases`</span>
<span class="sd">--INFO-- Processing `raw_nlp_phrases` column</span>
<span class="sd">--INFO-- Concatenating `raw_nlp_phrases` and `raw_keywords` columns to `raw_descriptors`</span>
<span class="sd">--INFO-- Processing `raw_descriptors` column</span>
<span class="sd">--INFO-- Searching `references` using DOI</span>
<span class="sd">--INFO-- Searching `references` using (year, title, author)</span>
<span class="sd">--INFO-- Searching `references` using (title)</span>
<span class="sd">--INFO-- Creating `local_citations` column in references database</span>
<span class="sd">--INFO-- Creating `local_citations` column in documents database</span>
<span class="sd">--INFO-- The data/regtech/countries.txt thesaurus file was created</span>
<span class="sd">--INFO-- Creating `descriptors.txt` from author/index keywords, and abstract/title nlp phrases</span>
<span class="sd">--INFO-- The data/regtech/organizations.txt thesaurus file was created</span>
<span class="sd">--INFO-- The data/regtech/countries.txt thesaurus file was applied to affiliations in all databases</span>
<span class="sd">--INFO-- Applying `descriptors.txt` thesaurus to author/index keywords and abstract/title words</span>
<span class="sd">--INFO-- The data/regtech/organizations.txt thesaurus file was applied to affiliations in all databases</span>
<span class="sd">--INFO-- Process finished!!!</span>
<span class="sd">--INFO-- data/regtech/databases/_references.csv: 909 imported records</span>
<span class="sd">--INFO-- data/regtech/databases/_main.csv: 52 imported records</span>
<span class="sd">--INFO-- data/regtech/databases/_cited_by.csv: 387 imported records</span>

<span class="sd">&gt;&gt;&gt; import pandas as pd</span>
<span class="sd">&gt;&gt;&gt; from pprint import pprint</span>
<span class="sd">&gt;&gt;&gt; import textwrap</span>
<span class="sd">&gt;&gt;&gt; root_dir = &quot;data/regtech/&quot;</span>
<span class="sd">&gt;&gt;&gt; my_list = pd.read_csv(root_dir + &quot;databases/_main.csv&quot;, encoding=&quot;utf-8&quot;).columns.tolist()</span>
<span class="sd">&gt;&gt;&gt; wrapped_list = textwrap.fill(&quot;, &quot;.join(sorted(my_list)), width=79)</span>
<span class="sd">&gt;&gt;&gt; print(wrapped_list)</span>
<span class="sd">abstract, abstract_nlp_phrases, affiliations, art_no, article, author_keywords,</span>
<span class="sd">authors, authors_id, authors_with_affiliations, coden, correspondence_address,</span>
<span class="sd">countries, country_1st_author, descriptors, document_type, doi, eid,</span>
<span class="sd">global_citations, global_references, index_keywords, isbn, issn, issue,</span>
<span class="sd">keywords, link, local_citations, local_references, nlp_phrases, num_authors,</span>
<span class="sd">num_global_references, open_access, organization_1st_author, organizations,</span>
<span class="sd">page_end, page_start, publication_stage, raw_abstract_nlp_phrases,</span>
<span class="sd">raw_author_keywords, raw_authors, raw_authors_id, raw_countries,</span>
<span class="sd">raw_descriptors, raw_index_keywords, raw_keywords, raw_nlp_phrases,</span>
<span class="sd">raw_organizations, raw_title_nlp_phrases, source, source_abbr, source_title,</span>
<span class="sd">title, title_nlp_phrases, volume, year</span>






<span class="sd">&gt;&gt;&gt; recors = pd.read_csv(root_dir + &quot;databases/_main.csv&quot;, encoding=&quot;utf-8&quot;)</span>
<span class="sd">&gt;&gt;&gt; print(recors[[&quot;raw_authors_id&quot;, &quot;authors_id&quot;]].head().to_markdown())</span>
<span class="sd">|    | raw_authors_id                                                           | authors_id                                                                                                                                            |</span>
<span class="sd">|---:|:-------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------|</span>
<span class="sd">|  0 | 57194137877;57694114300;35369323900;                                     | 000000000000057194137877;000000000000057694114300;000000000000035369323900                                                                            |</span>
<span class="sd">|  1 | 58065730600;25928338900;57212494182;                                     | 000000000000058065730600;000000000000025928338900;000000000000057212494182                                                                            |</span>
<span class="sd">|  2 | 9633912200;57203071719;                                                  | 000000000000009633912200;000000000000057203071719                                                                                                     |</span>
<span class="sd">|  3 | 57211924905;57218104231;56779331500;56645203200;57439248400;56291956400; | 000000000000057211924905;000000000000057218104231;000000000000056779331500;000000000000056645203200;000000000000057439248400;000000000000056291956400 |</span>
<span class="sd">|  4 | 57206840410;57226162166;57189220315;                                     | 000000000000057206840410;000000000000057226162166;000000000000057189220315                                                                            |</span>

<span class="sd">    </span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">textblob</span> <span class="kn">import</span> <span class="n">TextBlob</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">..refine.apply_countries_thesaurus</span> <span class="kn">import</span> <span class="n">apply_countries_thesaurus</span>
<span class="kn">from</span> <span class="nn">..refine.apply_descriptors_thesaurus</span> <span class="kn">import</span> <span class="n">apply_descriptors_thesaurus</span>
<span class="kn">from</span> <span class="nn">..refine.apply_organizations_thesaurus</span> <span class="kn">import</span> <span class="n">apply_organizations_thesaurus</span>

<span class="c1"># from ..reports import abstracts_report</span>
<span class="kn">from</span> <span class="nn">.create_countries_thesaurus</span> <span class="kn">import</span> <span class="n">create_countries_thesaurus</span>
<span class="kn">from</span> <span class="nn">.create_descriptors_thesaurus</span> <span class="kn">import</span> <span class="n">create_descriptors_thesaurus</span>
<span class="kn">from</span> <span class="nn">.create_organizations_thesaurus</span> <span class="kn">import</span> <span class="n">create_organizations_thesaurus</span>

<span class="n">KEYWORDS_MAX_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>


<div class="viewcode-block" id="ingest_raw_data"><a class="viewcode-back" href="../../../techminer/ingest/ingest_raw_data.html#techminer2.ingest.ingest_raw_data.ingest_raw_data">[docs]</a><span class="k">def</span> <span class="nf">ingest_raw_data</span><span class="p">(</span><span class="n">root_dir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">document_types</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Import a Scopus data file in the working directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir (str): The root directory to import the data to.</span>
<span class="sd">        disable_progress_bar (bool): Whether to disable the progress bar.</span>
<span class="sd">        **document_types: Keyword arguments specifying the document types to import.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># Phase 1: Preparing database files</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="n">create_working_directories</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">create_stopword_txt_file</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">create_database_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">rename_scopus_columns_in_database_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">format_columns_names_in_database_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">repair_authors_id_in_database_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">repair_bad_separators_in_keywords</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="n">discarded_types</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">document_types</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="p">]</span>

    <span class="n">remove_records</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;document_type&quot;</span><span class="p">,</span> <span class="n">discarded_types</span><span class="p">)</span>
    <span class="n">drop_empty_columns_in_database_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># Phase 2: Process each column in isolation</span>
    <span class="c1">#</span>
    <span class="c1">#</span>

    <span class="n">process_text_columns</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s2">&quot;NFKD&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
        <span class="s2">&quot;remove accents&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">process_text_columns</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;lpar;&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;rpar;&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;colon;&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">),</span>
        <span class="s2">&quot;remove stranger chars&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">remove_records</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;raw_authors&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;Anon&quot;</span><span class="p">,</span> <span class="s2">&quot;[No author name available]&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;authors_id&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;[No author id available]&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;document_type&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;eissn&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;global_citations&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;isbn&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;issn&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;raw_authors&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;[No author name available]&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;source_name&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^\w\s]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">mask_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;source_abbr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;source_name&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;source_abbr&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; JOURNAL &quot;</span><span class="p">,</span> <span class="s2">&quot; J &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; AND &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; IN &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; OF &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; ON &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; THE &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">29</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;doi&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;https://doi.org/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;http://dx.doi.org/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="n">disambiguate_author_names</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="n">copy_to_column</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="s2">&quot;num_authors&quot;</span><span class="p">)</span>
    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;num_authors&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">copy_to_column</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;global_references&quot;</span><span class="p">,</span> <span class="s2">&quot;num_global_references&quot;</span><span class="p">)</span>
    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;num_global_references&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">create__article__column</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># Phase 3: Keywords &amp; noun phrases &amp; abstracts</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># In the context of topic modeling for research abstracts, it is generally</span>
    <span class="c1"># more common and beneficial to use &quot;noun phrases&quot; extracted using text</span>
    <span class="c1"># mining techniques rather than relying solely on provided &quot;keywords&quot; for</span>
    <span class="c1"># the given document.</span>
    <span class="c1">#</span>
    <span class="c1"># Research abstracts often contain technical and domain-specific</span>
    <span class="c1"># language, making it challenging to accurately capture the main topics</span>
    <span class="c1"># and themes using only manually assigned or provided keywords. On the</span>
    <span class="c1"># other hand, using text mining techniques to extract noun phrases can</span>
    <span class="c1"># help uncover more nuanced and contextually relevant phrases that better</span>
    <span class="c1"># represent the content of the abstracts.</span>
    <span class="c1">#</span>
    <span class="c1"># Text mining techniques, such as part-of-speech tagging, noun phrase</span>
    <span class="c1"># chunking, or natural language processing algorithms, can identify</span>
    <span class="c1"># meaningful noun phrases that may not be explicitly listed as keywords.</span>
    <span class="c1"># These extracted noun phrases can provide a more comprehensive</span>
    <span class="c1"># representation of the topics present in the research abstracts,</span>
    <span class="c1"># allowing for more accurate and informative topic modeling.</span>
    <span class="c1">#</span>
    <span class="c1"># Therefore, leveraging text mining techniques to extract noun phrases is</span>
    <span class="c1"># often preferred over relying solely on provided keywords when</span>
    <span class="c1"># conducting topic modeling on research abstracts.</span>
    <span class="c1">#</span>

    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># Prepare author/index keywords:</span>
    <span class="c1"># To upper() and replace spaces with underscores</span>
    <span class="c1"># Merge author/index keywords into a single column</span>
    <span class="c1">#</span>
    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;raw_author_keywords&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;AND&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;   &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_(&quot;</span><span class="p">,</span> <span class="s2">&quot; (&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">w</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">na_action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;raw_index_keywords&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;AND&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;   &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_(&quot;</span><span class="p">,</span> <span class="s2">&quot; (&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">w</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">na_action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">concatenate_columns</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;raw_keywords&quot;</span><span class="p">,</span>
        <span class="s2">&quot;raw_author_keywords&quot;</span><span class="p">,</span>
        <span class="s2">&quot;raw_index_keywords&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Prepare title:</span>
    <span class="c1"># To lower() &amp; remove brackets &amp; remove multiple spaces &amp; strip</span>
    <span class="c1">#</span>
    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;   &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Technological Emergence Indicators using Emergence Score</span>
    <span class="c1"># Garner et al. 2017.</span>
    <span class="c1"># ------------------------------------------------------------------------</span>
    <span class="c1">#</span>
    <span class="c1"># Suitable terms for determining emergence are presented both in title and</span>
    <span class="c1"># the abstract. This allows to augment the list of terms given by the</span>
    <span class="c1"># authors/index keywords</span>
    <span class="c1">#</span>

    <span class="c1">#</span>
    <span class="c1"># Step 1: Create a candidate list of title nlp phrases</span>
    <span class="c1">#</span>
    <span class="n">copy_to_column</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;raw_title_nlp_phrases&quot;</span><span class="p">)</span>
    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;raw_title_nlp_phrases&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">TextBlob</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">noun_phrases</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">na_action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">,</span> <span class="n">na_action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">z</span> <span class="o">!=</span> <span class="s2">&quot;nan&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;   &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;_&quot;</span><span class="p">,</span> <span class="s2">&quot;; &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">x</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Step 2: Create a candidate list of abstract nlp phrases</span>
    <span class="c1">#</span>
    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;abstract&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;[no abstract available]&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="n">copy_to_column</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;abstract&quot;</span><span class="p">,</span> <span class="s2">&quot;raw_abstract_nlp_phrases&quot;</span><span class="p">)</span>
    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;raw_abstract_nlp_phrases&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">TextBlob</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">noun_phrases</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">,</span> <span class="n">na_action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">na_action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">z</span> <span class="o">!=</span> <span class="s2">&quot;nan&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;   &quot;</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;_&quot;</span><span class="p">,</span> <span class="s2">&quot;; &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">x</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Step 3: Filter terms in title and abstract nlp phrases</span>
    <span class="c1">#</span>
    <span class="n">filter_nlp_phrases</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Continue normal processing ....</span>
    <span class="c1">#</span>
    <span class="n">concatenate_columns</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;raw_nlp_phrases&quot;</span><span class="p">,</span>
        <span class="s2">&quot;raw_title_nlp_phrases&quot;</span><span class="p">,</span>
        <span class="s2">&quot;raw_abstract_nlp_phrases&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;raw_nlp_phrases&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">z</span> <span class="o">!=</span> <span class="s2">&quot;nan&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">x</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">concatenate_columns</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;raw_descriptors&quot;</span><span class="p">,</span>
        <span class="s2">&quot;raw_nlp_phrases&quot;</span><span class="p">,</span>
        <span class="s2">&quot;raw_keywords&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">process_column</span><span class="p">(</span>
        <span class="n">root_dir</span><span class="p">,</span>
        <span class="s2">&quot;raw_descriptors&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">z</span> <span class="o">!=</span> <span class="s2">&quot;nan&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">x</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">transform_abstract_keywords_to_underscore</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># Phase 4: References</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="n">create_references</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="p">)</span>
    <span class="n">create__local_citations__column_in_references_database</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">create__local_citations__column_in_documents_database</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># Phase 5: Thesaurus files</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="n">create_countries_thesaurus</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">create_descriptors_thesaurus</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">create_organizations_thesaurus</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="n">apply_countries_thesaurus</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">apply_descriptors_thesaurus</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">apply_organizations_thesaurus</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Process finished!!!&quot;</span><span class="p">)</span>

    <span class="c1">##abstracts_report(root_dir=root_dir, file_name=&quot;imported_records.txt&quot;)</span>
    <span class="n">report_imported_records_per_file</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span></div>


<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># End of main function</span>
<span class="c1">#</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">create_working_directories</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the working directories for the Scopus data.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir (str): The root directory to create the directories in.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;databases&quot;</span><span class="p">,</span> <span class="s2">&quot;reports&quot;</span><span class="p">]:</span>
        <span class="n">directory_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_stopword_txt_file</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an empty stopwords.txt file if it doesn&#39;t exist.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir (str): The root directory containing the processed directory.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;stopwords.txt&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">):</span>
            <span class="k">pass</span>


<span class="k">def</span> <span class="nf">create_database_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create processed CSV files from raw CSV files.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir (str): The root directory containing the raw and processed directories.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raw_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;raw-data&quot;</span><span class="p">)</span>
    <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases&quot;</span><span class="p">)</span>

    <span class="n">folders</span> <span class="o">=</span> <span class="n">get_subdirectories</span><span class="p">(</span><span class="n">raw_dir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">concat_raw_csv_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">))</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processed_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_DO_NOT_TOUCH_.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">def</span> <span class="nf">get_subdirectories</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a list of subdirectories in a directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory (str): The directory to get the subdirectories from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of subdirectories.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subdirectories</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">subdirectories</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">subdirectories</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">subdirectories</span>


<span class="k">def</span> <span class="nf">concat_raw_csv_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenate raw CSV files in a directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): The path to the directory containing the raw CSV files.</span>
<span class="sd">        quiet (bool): Whether to suppress output.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A pandas DataFrame containing the concatenated data.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- Concatenating raw files in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">get_csv_files</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No CSV files found in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">get_csv_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a list of CSV files in a directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory (str): The directory to get the CSV files from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of CSV files.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csv_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">csv_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">csv_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">csv_files</span>


<span class="k">def</span> <span class="nf">rename_scopus_columns_in_database_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rename Scopus columns in the processed CSV files.</span>

<span class="sd">    The name equivalences are stored in a repository file.</span>




<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Applying scopus tags to database files&quot;</span><span class="p">)</span>

    <span class="n">owner</span> <span class="o">=</span> <span class="s2">&quot;jdvelasq&quot;</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="s2">&quot;techminer2&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;settings/scopus2tags.csv&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://raw.githubusercontent.com/</span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">/main/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;scopus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;scopus&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;techminer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;techminer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">scopus2tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s2">&quot;scopus&quot;</span><span class="p">],</span> <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;techminer&quot;</span><span class="p">]))</span>

    <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;databases&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">processed_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;_*.csv&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">scopus2tags</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">filter_nlp_phrases</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter nlp phrases in abstract and title</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_nlp_phrases</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
        <span class="n">databases_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;databases&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">databases_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;_*.csv&quot;</span><span class="p">))</span>
        <span class="n">nlp_phrases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">file_nlp_phrases</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">file_nlp_phrases</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">file_nlp_phrases</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">explode</span><span class="p">()</span>
                <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">nlp_phrases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_nlp_phrases</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nlp_phrases</span>

    <span class="k">def</span> <span class="nf">apply_filter_to_nlp_phrases</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">selected_nlp_phrases</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply filter to nlp phrases to the specicied column&quot;&quot;&quot;</span>

        <span class="n">databases_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;databases&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">databases_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;_*.csv&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
                <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
                <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">selected_nlp_phrases</span><span class="p">])</span>
                <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="s2">&quot;nan&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Main code:</span>
    <span class="c1">#</span>

    <span class="c1"># Obtain the raw nlp phrases</span>
    <span class="n">raw_keywords</span> <span class="o">=</span> <span class="n">get_nlp_phrases</span><span class="p">(</span><span class="s2">&quot;raw_keywords&quot;</span><span class="p">)</span>
    <span class="n">raw_title_nlp_phrases</span> <span class="o">=</span> <span class="n">get_nlp_phrases</span><span class="p">(</span><span class="s2">&quot;raw_title_nlp_phrases&quot;</span><span class="p">)</span>
    <span class="n">raw_abstract_nlp_phrases</span> <span class="o">=</span> <span class="n">get_nlp_phrases</span><span class="p">(</span><span class="s2">&quot;raw_abstract_nlp_phrases&quot;</span><span class="p">)</span>

    <span class="c1"># nlp phrases appearing in the title and abstract</span>
    <span class="n">selected_nlp_phrases</span> <span class="o">=</span> <span class="n">raw_title_nlp_phrases</span> <span class="o">&amp;</span> <span class="n">raw_abstract_nlp_phrases</span>

    <span class="c1"># adds raw keywords</span>
    <span class="n">selected_nlp_phrases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">raw_keywords</span><span class="p">)</span>

    <span class="n">apply_filter_to_nlp_phrases</span><span class="p">(</span>
        <span class="s2">&quot;raw_title_nlp_phrases&quot;</span><span class="p">,</span>
        <span class="n">selected_nlp_phrases</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">apply_filter_to_nlp_phrases</span><span class="p">(</span>
        <span class="s2">&quot;raw_abstract_nlp_phrases&quot;</span><span class="p">,</span>
        <span class="n">selected_nlp_phrases</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">format_columns_names_in_database_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format column names in database files.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir: The root directory containing the processed CSV files.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Formatting column names in database files&quot;</span><span class="p">)</span>

    <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;databases&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">processed_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;_*.csv&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">format_column_names</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">format_column_names</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format column names in a pandas DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The pandas DataFrame to format.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The pandas DataFrame with formatted column names.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">repair_authors_id_in_database_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Repair authors IDs in the processed CSV files.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir: The root directory containing the processed CSV files.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Repairing authors ID&quot;</span><span class="p">)</span>

    <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;databases&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">processed_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;_*.csv&quot;</span><span class="p">))</span>
    <span class="n">max_length</span> <span class="o">=</span> <span class="n">get_max_authors_id_length</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repair_authors_id</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_authors_id&quot;</span><span class="p">],</span> <span class="n">max_length</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_max_authors_id_length</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the maximum length of authors IDs in a list of CSV files.</span>

<span class="sd">    Args:</span>
<span class="sd">        files: A list of CSV files.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The maximum length of authors IDs.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_authors_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
        <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">repair_authors_id</span><span class="p">(</span><span class="n">authors_id</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Repair authors IDs in a pandas Series.</span>

<span class="sd">    Args:</span>
<span class="sd">        authors_id: The pandas Series containing authors IDs.</span>
<span class="sd">        max_length: The maximum length of authors IDs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The pandas Series with repaired authors IDs.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">authors_id</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">max_length</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">repair_bad_separators_in_keywords</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Repair keywords with bad separators in the processed CSV files.</span>

<span class="sd">    In Scopus, keywords are separated by semicolons. However, some records</span>
<span class="sd">    contain keywords separated by commas. This function repairs these</span>
<span class="sd">    keywords.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir: The root directory containing the processed CSV files.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Repairing bad separators in keywords&quot;</span><span class="p">)</span>
    <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;databases&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">processed_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;_*.csv&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;raw_index_keywords&quot;</span><span class="p">,</span> <span class="s2">&quot;raw_authors_keywords&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">repair_keywords_in_column</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">repair_keywords_in_column</span><span class="p">(</span><span class="n">raw_keywords</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Repair keywords in a pandas Series.</span>


<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="n">raw_keywords</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span><span class="p">[</span><span class="n">keywords</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">KEYWORDS_MAX_LENGTH</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--WARNING-- Keyword with bad separator: </span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">raw_keywords</span> <span class="o">=</span> <span class="n">raw_keywords</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">keyword</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">raw_keywords</span>


<span class="k">def</span> <span class="nf">remove_records</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">values_to_remove</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove records with a given value in a given column.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir (str): root directory.</span>
<span class="sd">        col_name (str): column name.</span>
<span class="sd">        values_to_remove (list): values to remove.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values_to_remove</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- Removing records with `</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">` in </span><span class="si">{</span><span class="n">values_to_remove</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">org_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">values_to_remove</span><span class="p">)]</span>
        <span class="n">new_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">org_length</span> <span class="o">!=</span> <span class="n">new_length</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- Removed </span><span class="si">{</span><span class="n">org_length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">new_length</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">drop_empty_columns_in_database_files</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Drop NA columns in database files.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Dropping NA columns in database files&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">original_cols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_cols</span><span class="p">):</span>
            <span class="n">removed_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">original_cols</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- Removed columns: </span><span class="si">{</span><span class="n">removed_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">process_text_columns</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">process_func</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process text columns in all database files.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir (str): root directory.</span>
<span class="sd">        process_func (function): function to be applied to each column.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- Processing text columns (</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_func</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">process_column</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">process_func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a column in all database files.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir (str): root directory.</span>
<span class="sd">        column_name (str): column name.</span>
<span class="sd">        process_func (function): function to be applied to the column.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- Processing `</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">` column&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_func</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">mask_column</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">masked_col</span><span class="p">,</span> <span class="n">rep_col</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mask a column in all database files.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- Mask `</span><span class="si">{</span><span class="n">masked_col</span><span class="si">}</span><span class="s2">` column with `</span><span class="si">{</span><span class="n">rep_col</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">masked_col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">rep_col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">masked_col</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">masked_col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="n">rep_col</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">disambiguate_author_names</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the authors column.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">load_authors_names</span><span class="p">():</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_*.csv&quot;</span><span class="p">)))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)[[</span><span class="s2">&quot;raw_authors&quot;</span><span class="p">,</span> <span class="s2">&quot;authors_id&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span>
        <span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">build_dict_names</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">authors_and_ids</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">raw_authors</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_id</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;authors_and_ids&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s2">&quot;authors_and_ids&quot;</span><span class="p">]]</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;author_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;authors_and_ids&quot;</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">counter</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;author&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumcount</span><span class="p">())</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">author</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/0&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">author_id2name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">author_id</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">author</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">author_id2name</span>

    <span class="k">def</span> <span class="nf">repair_names</span><span class="p">(</span><span class="n">author_id2name</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_*.csv&quot;</span><span class="p">)))</span>
        <span class="c1"># total_items = len(files)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">authors</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">authors_id</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">author_id2name</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Disambiguating `authors` column&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_authors_names</span><span class="p">()</span>
    <span class="n">author_id2name</span> <span class="o">=</span> <span class="n">build_dict_names</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">repair_names</span><span class="p">(</span><span class="n">author_id2name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">copy_to_column</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Copy a column in all database files.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- Copying `</span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">` column to `</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">concatenate_columns</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">column_name1</span><span class="p">,</span> <span class="n">column_name2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Concatenate two columns in all database files.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- Concatenating `</span><span class="si">{</span><span class="n">column_name1</span><span class="si">}</span><span class="s2">` and `</span><span class="si">{</span><span class="n">column_name2</span><span class="si">}</span><span class="s2">` columns to `</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">column_name1</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">column_name2</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">column_name1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">column_name2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">src</span> <span class="o">+</span> <span class="n">dst</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">z</span> <span class="o">!=</span> <span class="s2">&quot;nan&quot;</span><span class="p">])</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">na_action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">na_action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span>

        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create__article__column</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a WoS style reference column.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># First Author, year, source_abbr, &#39;V&#39;volumne, &#39;P&#39;page_start, &#39; DOI &#39; doi</span>
    <span class="c1">#</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Creating `article` column&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">wos_ref</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;[Anonymous]&quot;</span>
        <span class="p">)</span>
        <span class="n">wos_ref</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">wos_ref</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span>
        <span class="n">wos_ref</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;, V&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.0&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">wos_ref</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">page_start</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;, P&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.0&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="c1"># wos_ref += data.doi.map(lambda x: &quot;, DOI &quot; + str(x) if not pd.isna(x) else &quot;&quot;)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wos_ref</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_references</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create references from `documents.csv` or `_references.csv` file.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">references_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;databases/_references.csv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">references_path</span><span class="p">):</span>
        <span class="n">create_references_from_references_csv_file</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">create_references_from_documents_csv_file</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_references_from_documents_csv_file</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create references from `documents.csv` file.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Creating references from  `_main.csv` file.&quot;</span><span class="p">)</span>

    <span class="n">documents_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;databases/_main.csv&quot;</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">)</span>

    <span class="c1"># references como aparecen en los articulos</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">global_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># record in document.csv ---&gt; reference</span>
    <span class="n">thesaurus</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>

    <span class="c1"># references = pd.read_csv(references_path)</span>

    <span class="c1"># marcador para indicar si la referencia fue encontrada</span>
    <span class="n">references</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">references</span><span class="p">[</span><span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># busqueda por doi</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using DOI&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">doi</span><span class="p">,</span> <span class="n">article</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">references</span><span class="o">.</span><span class="n">doi</span><span class="p">,</span> <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span> <span class="ow">and</span> <span class="n">doi</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">doi</span> <span class="o">==</span> <span class="n">doi</span><span class="p">,</span> <span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reduce la base de bsqueda</span>
    <span class="n">references</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="o">~</span><span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">]</span>

    <span class="c1"># Busqueda por (ao, autor y tttulo)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using (year, title, author)&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">authors</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">authors</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">authors</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">title</span><span class="p">[:</span><span class="mi">29</span><span class="p">]</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">title</span><span class="p">[</span><span class="o">-</span><span class="mi">29</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reduce la base de bsqueda</span>
    <span class="n">references</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="o">~</span><span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">]</span>

    <span class="c1"># Busqueda por titulo</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using (title)&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                    <span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Crea la columna de referencias locales</span>
    <span class="c1">#</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">global_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">thesaurus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">documents</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_references_from_references_csv_file</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the references from the references.csv file.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">references_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;databases/_references.csv&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">references_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--WARN-- The  file </span><span class="si">{</span><span class="n">references_path</span><span class="si">}</span><span class="s2"> does not exists.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--WARN-- Some functionalities are disabled.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">references</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">references_path</span><span class="p">)</span>

    <span class="n">documents_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;databases/_main.csv&quot;</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">)</span>

    <span class="c1"># references como aparecen en los articulos</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">global_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># raw_cited_reference --&gt; article</span>
    <span class="n">thesaurus</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>

    <span class="c1"># marcador para indicar si la referencia fue encontrada</span>
    <span class="n">references</span><span class="p">[</span><span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># busqueda por doi</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using DOI&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">doi</span><span class="p">,</span> <span class="n">article</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">references</span><span class="o">.</span><span class="n">doi</span><span class="p">,</span> <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span> <span class="ow">and</span> <span class="n">doi</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">doi</span> <span class="o">==</span> <span class="n">doi</span><span class="p">,</span> <span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reduce la base de bsqueda</span>
    <span class="n">references</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="o">~</span><span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">]</span>

    <span class="c1"># Busqueda por (ao, autor y tttulo)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using (year, title, author)&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">authors</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">authors</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">authors</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">article</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">authors</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">title</span><span class="p">[:</span><span class="mi">29</span><span class="p">]</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">,</span> <span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">title</span><span class="p">[</span><span class="o">-</span><span class="mi">29</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">,</span> <span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reduce la base de bsqueda</span>
    <span class="n">references</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="o">~</span><span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">]</span>

    <span class="c1"># Busqueda por titulo</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using (title)&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">,</span> <span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Crea la columna de referencias locales</span>
    <span class="c1">#</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">global_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">thesaurus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># NOTA: realmente local_references contiene las referencias globales</span>
    <span class="c1"># en formato WoS</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;global_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">#</span>
    <span class="c1"># Se filtran local references para que contengan unicamente records</span>
    <span class="c1"># que estan en la base de datos principal</span>
    <span class="n">local_documents</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">article</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">local_documents</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="n">documents</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create__local_citations__column_in_references_database</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create `local_citations` column in references database</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">references_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;databases&quot;</span><span class="p">,</span> <span class="s2">&quot;_references.csv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">references_path</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Creating `local_citations` column in references database&quot;</span><span class="p">)</span>

    <span class="c1"># counts the number of citations for each local reference</span>
    <span class="n">documents_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;databases&quot;</span><span class="p">,</span> <span class="s2">&quot;_main.csv&quot;</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">)</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">local_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">values_dict</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># assigns the number of citations to each reference in references database</span>

    <span class="n">references</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">references_path</span><span class="p">)</span>
    <span class="n">references</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">references</span><span class="o">.</span><span class="n">article</span>
    <span class="n">references</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">values_dict</span><span class="p">)</span>
    <span class="n">references</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># saves the new column in the references database</span>
    <span class="n">references</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">references_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create__local_citations__column_in_documents_database</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create `local_citations` column in documents database</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--INFO-- Creating `local_citations` column in documents database&quot;</span><span class="p">)</span>

    <span class="c1"># counts the number of citations for each local reference</span>
    <span class="n">documents_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases&quot;</span><span class="p">,</span> <span class="s2">&quot;_main.csv&quot;</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">)</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">local_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">values_dict</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># assigns the number of citations to each document in documents database</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">article</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">values_dict</span><span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># saves the new column in the references database</span>
    <span class="n">documents</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">report_imported_records_per_file</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Report the number of imported records per file.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir (str): root directory.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s2">&quot;databases/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2"> imported records&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">transform_abstract_keywords_to_underscore</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform keywords in abstracts to uppercase</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_raw_descriptors</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a pandas Series with all NLP phrases in the database files&quot;&quot;&quot;</span>
        <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;databases&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">processed_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;_*.csv&quot;</span><span class="p">))</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;raw_nlp_phrases&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">candidate_descriptors</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_descriptors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">candidate_descriptors</span> <span class="o">=</span> <span class="n">candidate_descriptors</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">descriptors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate_descriptors</span><span class="p">)</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="c1"># nlp_phrases = nlp_phrases[nlp_phrases.str.contains(&quot; &quot;)]</span>
        <span class="k">return</span> <span class="n">descriptors</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">descriptors</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove abbreviations from NLP phrases&quot;&quot;&quot;</span>

        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># remove abbreviations</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(.*\)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;\[].*\]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># strage characters</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">descriptors</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">descriptors</span><span class="p">[</span><span class="n">descriptors</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">descriptors</span>

    <span class="k">def</span> <span class="nf">sort_by_num_words</span><span class="p">(</span><span class="n">descriptors</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sort keywords by number of words&quot;&quot;&quot;</span>

        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="n">frame</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">descriptors</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">descriptors</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">descriptors</span>

    <span class="k">def</span> <span class="nf">replace_in_abstracts_and_titles</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">descriptors</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace keywords in abstracts&quot;&quot;&quot;</span>

        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="p">]</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\b(&quot;</span> <span class="o">+</span> <span class="n">descriptors</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\b&quot;</span>

        <span class="n">documents_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;databases/_main.csv&quot;</span>
        <span class="n">documents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;abstract&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">]:</span>
            <span class="n">hyphenated_words</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b\w+-\w+\b&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">hyphenated_words</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">hyphenated_words</span><span class="p">))</span>
            <span class="n">hyphenated_words</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\b(&quot;</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hyphenated_words</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\b&quot;</span>
            <span class="c1">#</span>
            <span class="n">aux</span> <span class="o">=</span> <span class="n">hyphenated_words</span><span class="p">[</span><span class="mi">9370</span><span class="p">:]</span>
            <span class="c1">#</span>
            <span class="n">documents</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">documents</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">documents</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="n">hyphenated_words</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
                <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">documents</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Main code:</span>
    <span class="c1">#</span>
    <span class="n">descriptors</span> <span class="o">=</span> <span class="n">get_raw_descriptors</span><span class="p">()</span>
    <span class="n">descriptors</span> <span class="o">=</span> <span class="n">clean</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span>
    <span class="n">descriptors</span> <span class="o">=</span> <span class="n">sort_by_num_words</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span>
    <span class="n">replace_in_abstracts_and_titles</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">descriptors</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>